{% extends 'base.html' %}
{% load static %}

{% block title %}Track Shipment - Package Tracker{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS for Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .table td {
        padding: 15px;
        vertical-align: middle;
        border-color: #dee2e6;
    }
    
    .info-card {
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .info-card:hover {
        transform: translateY(-5px);
    }
    
    /* Barcode Styles */
    .barcode-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: inline-block;
    }
    
    /* Map Styles */
    #map {
        height: 400px;
        width: 100%;
        border-radius: 10px;
        margin-top: 20px;
    }
    
    /* Tab Styles */
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 20px;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #666;
        font-weight: 500;
        padding: 12px 25px;
        margin-right: 5px;
    }
    
    .nav-tabs .nav-link.active {
        background: #e53935;
        color: white;
        border-radius: 25px;
        border: none;
    }
    
    .nav-tabs .nav-link:hover {
        border: none;
        border-radius: 25px;
    }
    
    .tab-content {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        margin-top: 0px;
    }
    
    /* Loading state for button */
    .btn-loading {
        position: relative;
        color: transparent !important;
    }
    
    .btn-loading:after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin-left: -10px;
        margin-top: -10px;
        border: 2px solid #e53935;
        border-radius: 50%;
        border-right-color: transparent;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Package table styles */
    .package-table th {
        background: #2c3e50;
        color: white;
        font-weight: 600;
    }
    
    .totals-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .status-badge {
        display: inline-block;
        background: #e74c3c;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-size: 20px;
        font-weight: bold;
    }
    
    .badge {
        padding: 8px 12px;
        font-size: 12px;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Tracking Form Section -->
<div class="tracking-section" style="background: linear-gradient(135deg, #e53935 0%, #c62828 100%); padding: 40px 0 60px;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="tracking-form-container text-center">
                    <h2 class="tracking-title" style="color: white; margin-bottom: 20px; font-size: clamp(28px, 5vw, 36px); font-weight: 700; line-height: 1.2;">Track Your Package</h2>
                    <p class="tracking-subtitle" style="color: rgba(255,255,255,0.9); margin-bottom: 30px; font-size: clamp(16px, 2.5vw, 18px); padding: 0 10px; line-height: 1.5;">
                        Enter your tracking number to check real-time package status and delivery updates
                    </p>
                    
                    <form method="post" class="tracking-form" id="trackingForm">
                        {% csrf_token %}
                        <div class="input-group input-group-lg search-container" style="max-width: 700px; margin: 0 auto; display: flex; align-items: stretch;">
                            <input type="text" name="tracking_number" 
                                   id="tracking_number"
                                   value="{{ tracking_number }}"
                                   class="form-control track-input" 
                                   placeholder="Enter your tracking number (e.g., 8725 0000 9715 000)"
                                   style="border: none; border-radius: 50px 0 0 50px; padding: 15px 25px; font-size: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; min-height: 56px; flex: 1;"
                                   required
                                   autocomplete="off">
                            <button type="submit" 
                                    id="trackButton"
                                    class="btn btn-light track-button"
                                    style="background: white; color: #e53935; border: none; border-radius: 0 50px 50px 0; padding: 15px 30px; font-size: 15px; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; min-height: 56px; min-width: 140px; white-space: nowrap; margin-left: -1px;">
                                <i class="fa fa-search" style="margin-right: 6px;"></i> Track
                            </button>
                        </div>
                    </form>

                    <div class="tracking-features" style="margin-top: 40px; display: flex; justify-content: center; gap: clamp(20px, 5vw, 40px); flex-wrap: wrap;">
                        <div style="color: white; text-align: center; min-width: 120px;">
                            <i class="fa fa-clock-o" style="font-size: clamp(20px, 4vw, 24px); margin-bottom: 8px;"></i>
                            <div style="font-size: clamp(14px, 2vw, 16px);">Real-time Updates</div>
                        </div>
                        <div style="color: white; text-align: center; min-width: 120px;">
                            <i class="fa fa-map-marker" style="font-size: clamp(20px, 4vw, 24px); margin-bottom: 8px;"></i>
                            <div style="font-size: clamp(14px, 2vw, 16px);">Live Location</div>
                        </div>
                        <div style="color: white; text-align: center; min-width: 120px;">
                            <i class="fa fa-bell" style="font-size: clamp(20px, 4vw, 24px); margin-bottom: 8px;"></i>
                            <div style="font-size: clamp(14px, 2vw, 16px);">Notifications</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Results Section -->
<div class="container" style="padding: 60px 0;">
    {% if shipment %}
        <!-- Shipment Found -->
        <div class="tracking-results">
            <!-- Header Section -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <img src="{% static 'img/logo-dark.png' %}" alt="">
                </div>
                <div class="col-md-6 text-right">
                    <h2 style="font-size: 24px; font-weight: bold; color: #333; margin: 0;">{{ shipment.shipment_number }}</h2>
                </div>
            </div>

            <!-- Real Barcode Section - RESPONSIVE -->
            <div class="text-center mb-5">
                <div class="barcode-container" style="max-width: 100%; overflow: hidden; padding: 15px;">
                    <div style="width: 100%; overflow-x: auto;">
                        <svg id="barcode" style="max-width: 100%; height: auto;"></svg>
                    </div>
                </div>
                <div style="margin-top: 10px; color: #666; font-family: monospace; word-break: break-all; padding: 0 10px;">
                    {{ shipment.shipment_number }}
                </div>
            </div>

            <!-- Shipper and Receiver Information -->
            <div class="row mb-5">
                <div class="col-md-6">
                    <div class="info-card">
                        <div class="card-header" style="background: #2c3e50; color: white; padding: 15px; font-weight: bold;">
                            Shipper Information
                        </div>
                        <div class="card-body" style="padding: 20px;">
                            <p style="margin: 0; line-height: 1.6;">
                                <strong>{{ shipment.shipper_name }}</strong><br>
                                {{ shipment.shipper_address }}<br>
                                {{ shipment.shipper_phone }}<br>
                                {{ shipment.shipper_email }}
                            </p>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="info-card">
                        <div class="card-header" style="background: #2c3e50; color: white; padding: 15px; font-weight: bold;">
                            Receiver Information
                        </div>
                        <div class="card-body" style="padding: 20px;">
                            <p style="margin: 0; line-height: 1.6;">
                                <strong>{{ shipment.receiver_name }}</strong><br>
                                {{ shipment.receiver_address }}<br>
                                {{ shipment.receiver_phone }}<br>
                                {{ shipment.receiver_email }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Section -->
            <div class="text-center mb-5">
                <div style="font-size: 18px; color: #666; margin-bottom: 10px;">SHIPMENT STATUS:</div>
                <div class="status-badge">
                    {{ shipment.status.name}}
                </div>
            </div>

            <!-- Tabs Section -->
            <ul class="nav nav-tabs" id="trackingTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="details-tab" data-toggle="tab" href="#details" role="tab" aria-controls="details" aria-selected="true">Shipment Details</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="packages-tab" data-toggle="tab" href="#packages" role="tab" aria-controls="packages" aria-selected="false">Packages</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="history-tab" data-toggle="tab" href="#history" role="tab" aria-controls="history" aria-selected="false">Shipment History</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="map-tab" data-toggle="tab" href="#map-view" role="tab" aria-controls="map-view" aria-selected="false">Map View</a>
                </li>
            </ul>

            <div class="tab-content" id="trackingTabsContent">
                <!-- Shipment Details Tab -->
                <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                    <h3 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #e53935; padding-bottom: 10px;">Shipment Information</h3>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <tbody>
                                <tr>
                                    <td style="width: 25%; font-weight: bold; background: #f8f9fa;">Origin:</td>
                                    <td style="width: 25%;">{{ shipment.origin.name|default:"Not specified" }}</td>
                                    <td style="width: 25%; font-weight: bold; background: #f8f9fa;">Packages:</td>
                                    <td style="width: 25%;">{{ shipment.packages }}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold; background: #f8f9fa;">Destination:</td>
                                    <td>{{ shipment.destination.name|default:"Not specified" }}</td>
                                    <td style="font-weight: bold; background: #f8f9fa;">Carrier:</td>
                                    <td>{{ shipment.carrier.name|default:"Not specified" }}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold; background: #f8f9fa;">Weight:</td>
                                    <td>{{ shipment.weight_kg }} kg</td>
                                    <td style="font-weight: bold; background: #f8f9fa;">Shipment Mode:</td>
                                    <td>{{ shipment.mode.name|default:"Not specified" }}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold; background: #f8f9fa;">Product:</td>
                                    <td>{{ shipment.product.name|default:"Not specified" }}</td>
                                    <td style="font-weight: bold; background: #f8f9fa;">Quantity:</td>
                                    <td>{{ shipment.quantity }}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold; background: #f8f9fa;">Total Freight:</td>
                                    <td>{{ shipment.total_freight|default:"Not specified" }}</td>
                                    <td style="font-weight: bold; background: #f8f9fa;">Expected Delivery Date:</td>
                                    <td>{{ shipment.expected_delivery_date|date:"Y-m-d" }}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold; background: #f8f9fa;">Pick-up Date:</td>
                                    <td>{{ shipment.pickup_date|date:"Y-m-d" }}</td>
                                    <td style="font-weight: bold; background: #f8f9fa;">Pick-up Time:</td>
                                    <td>{{ shipment.pickup_time|time:"H:i" }}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold; background: #f8f9fa;">Departure Time:</td>
                                    <td>{{ shipment.departure_time|time:"H:i" }}</td>
                                    <td style="font-weight: bold; background: #f8f9fa;">Payment Mode:</td>
                                    <td>{{ shipment.payment_mode.name|default:"Not specified" }}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold; background: #f8f9fa;">Shipment Type:</td>
                                    <td>{{ shipment.shipment_type.name|default:"Not specified" }}</td>
                                    <td style="font-weight: bold; background: #f8f9fa;">Carrier Reference No.:</td>
                                    <td>{{ shipment.carrier_reference_no|default:"Not specified" }}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold; background: #f8f9fa;">Courier:</td>
                                    <td>{{ shipment.courier.name|default:"Not specified" }}</td>
                                    <td style="font-weight: bold; background: #f8f9fa;">Current Location:</td>
                                    <td>{{ shipment.location.name|default:"In transit" }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    {% if shipment.comments %}
                    <div class="comments-section mt-4">
                        <h4 style="color: #333; margin-bottom: 15px;">Comments:</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #e53935;">
                            {{ shipment.comments }}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Packages Tab -->
                <div class="tab-pane fade" id="packages" role="tabpanel" aria-labelledby="packages-tab">
                    <h3 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #e53935; padding-bottom: 10px;">Packages</h3>
                    
                    {% if packages %}
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped package-table">
                            <thead>
                                <tr>
                                    <th>QTY</th>
                                    <th>PIECE TYPE</th>
                                    <th>DESCRIPTION</th>
                                    <th>LENGTH (CM)</th>
                                    <th>WIDTH (CM)</th>
                                    <th>HEIGHT (CM)</th>
                                    <th>VOLUME (CM³)</th>
                                    <th>WEIGHT (KG)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for package in packages %}
                                <tr>
                                    <td>{{ package.qty }}</td>
                                    <td>{{ package.piece_type.name|default:"Not specified" }}</td>
                                    <td>{{ package.description|default:"General Goods" }}</td>
                                    <td>{{ package.length_cm }}</td>
                                    <td>{{ package.width_cm }}</td>
                                    <td>{{ package.height_cm }}</td>
                                    <td>
                                        {% widthratio package.length_cm 1 package.width_cm as area %}
                                        {% widthratio area 1 package.height_cm as volume %}
                                        {{ volume|floatformat:2 }}
                                    </td>
                                    <td>{{ package.weight_kg }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Package Totals -->
                    <div class="totals-section">
                        <div class="row">
                            <div class="col-md-4">
                                <h5>Total Volumetric Weight</h5>
                                <p class="h4 text-primary">
                                    {% with total_vol_weight=0 %}
                                    {% for package in packages %}
                                        {% widthratio package.length_cm 1 package.width_cm as area %}
                                        {% widthratio area 1 package.height_cm as volume %}
                                        {% widthratio volume 5000 1 as vol_weight %}
                                        {% widthratio vol_weight 1 package.qty as package_vol_weight %}
                                        {{ package_vol_weight|floatformat:2 }}
                                    {% endfor %}
                                    kg
                                    {% endwith %}
                                </p>
                            </div>
                            <div class="col-md-4">
                                <h5>Total Volume</h5>
                                <p class="h4 text-success">
                                    {% with total_volume=0 %}
                                    {% for package in packages %}
                                        {% widthratio package.length_cm 1 package.width_cm as area %}
                                        {% widthratio area 1 package.height_cm as volume %}
                                        {% widthratio volume 1 package.qty as package_volume %}
                                        {{ package_volume|floatformat:2 }}
                                    {% endfor %}
                                    cm³
                                    {% endwith %}
                                </p>
                            </div>
                            <div class="col-md-4">
                                <h5>Total Actual Weight</h5>
                                <p class="h4 text-danger">
                                    {% with total_weight=0 %}
                                    {% for package in packages %}
                                        {% widthratio package.weight_kg 1 package.qty as package_weight %}
                                        {{ package_weight|floatformat:2 }}
                                    {% endfor %}
                                    kg
                                    {% endwith %}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">No package details available for this shipment.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Shipment History Tab -->
                <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                    <h3 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #e53935; padding-bottom: 10px;">Shipment History</h3>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>DATE</th>
                                    <th>TIME</th>
                                    <th>LOCATION</th>
                                    <th>STATUS</th>
                                    <th>UPDATED BY</th>
                                    <th>REMARKS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Current Status -->
                                <tr>
                                    <td>{{ shipment.date|date:"Y-m-d" }}</td>
                                    <td>{{ shipment.time|time:"H:i" }}</td>
                                    <td>{{ shipment.location.name}}</td>
                                    <td>
                                        <span class="badge badge-primary">{{ shipment.status.name|default:"Processing" }}</span>
                                    </td>
                                    <td>System</td>
                                    <td>{{ shipment.remarks|default:"Shipment is being processed" }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Map View Tab -->
                <div class="tab-pane fade" id="map-view" role="tabpanel" aria-labelledby="map-tab">
                    <h3 style="color: #333; margin-bottom: 20px; border-bottom: 2px solid #e53935; padding-bottom: 10px;">Shipment Location</h3>
                    
                    <div class="map-controls mb-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary active" id="mapView">Map</button>
                            <button type="button" class="btn btn-outline-primary" id="satelliteView">Satellite</button>
                        </div>
                    </div>
                    
                    <div id="map"></div>
                    
                    <div class="mt-3">
                        <h5>Current Location: {{ shipment.location.name}}</h5>
                        <p class="text-muted">Last updated: {{ shipment.date|date:"Y-m-d" }} at {{ shipment.time|time:"H:i" }}</p>
                    </div>
                </div>
            </div>
        </div>

    {% elif tracking_number %}
        <!-- No Shipment Found -->
        <div class="text-center py-5">
            <div style="font-size: 100px; color: #e53935; margin-bottom: 20px;">
                <i class="fa fa-exclamation-triangle"></i>
            </div>
            <h3 style="color: #333; margin-bottom: 15px;">Shipment Not Found</h3>
            <p style="color: #666; font-size: 16px;">
                No shipment found with tracking number: <strong>{{ tracking_number }}</strong><br>
                Please check the number and try again.
            </p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Barcode Library -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<!-- Leaflet JS for Map -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Enhanced form submission handler with fancy effects for track page
    (function() {
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const trackingForm = document.getElementById('trackingForm');
            const trackingInput = document.getElementById('tracking_number');
            const trackButton = document.getElementById('trackButton');
            
            if (!trackingForm || !trackingInput || !trackButton) return;
            
            // 1. Fancy cursor effect on search bar
            trackingInput.addEventListener('mouseenter', function() {
                this.style.cursor = 'text';
                this.style.boxShadow = '0 4px 20px rgba(0,0,0,0.2)';
                this.style.transition = 'all 0.3s ease';
            });
            
            trackingInput.addEventListener('mouseleave', function() {
                this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
            });
            
            trackingInput.addEventListener('focus', function() {
                this.style.cursor = 'text';
                this.style.boxShadow = '0 4px 25px rgba(0,0,0,0.25)';
                this.style.transform = 'scale(1.01)';
            });
            
            trackingInput.addEventListener('blur', function() {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
            });
            
            // 2. Fancy button hover effects
            trackButton.addEventListener('mouseenter', function() {
                this.style.cursor = 'pointer';
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
                this.style.transition = 'all 0.3s ease';
            });
            
            trackButton.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
            });
            
            // 3. Enhanced form submission with 2-second loader
            trackingForm.addEventListener('submit', function(e) {
                // Store original button content
                const originalHTML = trackButton.innerHTML;
                const originalWidth = trackButton.offsetWidth + 'px';
                const trackingNumber = trackingInput.value.trim();
                
                // Basic validation
                if (!trackingNumber) {
                    e.preventDefault();
                    
                    // Shake animation for empty input
                    trackingInput.style.animation = 'shake 0.5s';
                    trackingInput.focus();
                    
                    setTimeout(() => {
                        trackingInput.style.animation = '';
                    }, 500);
                    
                    return;
                }
                
                // Prevent double submission
                if (trackButton.disabled) {
                    e.preventDefault();
                    return;
                }
                
                e.preventDefault(); // Prevent immediate submission
                
                // Show fancy loading state
                trackButton.innerHTML = `
                    <span class="loading-spinner">
                        <i class="fa fa-spinner fa-spin" style="margin-right: 8px;"></i>
                        Tracking...
                    </span>
                `;
                trackButton.disabled = true;
                trackButton.style.width = originalWidth;
                trackButton.style.cursor = 'wait';
                trackButton.style.opacity = '0.9';
                
                // Add pulse animation to button
                trackButton.style.animation = 'pulse 1s infinite';
                
                // Add loading animation to input
                trackingInput.disabled = true;
                trackingInput.style.cursor = 'wait';
                trackingInput.style.opacity = '0.7';
                trackingInput.style.background = 'linear-gradient(90deg, #fff 0%, #f8f9fa 50%, #fff 100%)';
                trackingInput.style.backgroundSize = '200% 100%';
                trackingInput.style.animation = 'shimmer 2s infinite';
                
                console.log('Starting 2-second delay before submission...');
                console.log('Tracking number to submit:', trackingNumber);
                
                // Create a hidden clone form to submit
                setTimeout(() => {
                    console.log('Submitting form after 2-second delay...');
                    
                    // Remove animations
                    trackButton.style.animation = '';
                    trackingInput.style.animation = '';
                    
                    // Create a hidden form to submit
                    const hiddenForm = document.createElement('form');
                    hiddenForm.method = 'POST';
                    hiddenForm.action = trackingForm.action;
                    hiddenForm.style.display = 'none';
                    
                    // Add CSRF token
                    const csrfToken = document.createElement('input');
                    csrfToken.type = 'hidden';
                    csrfToken.name = 'csrfmiddlewaretoken';
                    csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    hiddenForm.appendChild(csrfToken);
                    
                    // Add tracking number
                    const trackingInputClone = document.createElement('input');
                    trackingInputClone.type = 'hidden';
                    trackingInputClone.name = 'tracking_number';
                    trackingInputClone.value = trackingNumber;
                    hiddenForm.appendChild(trackingInputClone);
                    
                    // Append to body and submit
                    document.body.appendChild(hiddenForm);
                    hiddenForm.submit();
                    
                }, 2000);
            });
            
            // 4. Add keypress animation
            trackingInput.addEventListener('keypress', function(e) {
                // Add subtle scale effect on keypress
                this.style.transform = 'scale(1.005)';
                setTimeout(() => {
                    this.style.transform = 'scale(1.01)';
                }, 50);
            });
            
            // Focus on input when page loads
            trackingInput.focus();
            
            // 5. Generate Barcode if shipment exists - RESPONSIVE
            {% if shipment %}
            try {
                // Calculate responsive width based on screen size
                const screenWidth = window.innerWidth;
                const isMobile = screenWidth <= 768;
                const isTablet = screenWidth <= 1024 && screenWidth > 768;
                
                // Adjust barcode width based on device
                let barcodeWidth = 2; // default
                
                if (isMobile) {
                    barcodeWidth = 1.5; // thinner lines for mobile
                } else if (isTablet) {
                    barcodeWidth = 1.8;
                }
                
                // Generate barcode
                JsBarcode("#barcode", "{{ shipment.shipment_number }}", {
                    format: "CODE128",
                    width: barcodeWidth,
                    height: isMobile ? 60 : 80, // shorter on mobile
                    displayValue: false,
                    background: "transparent",
                    lineColor: "#000000",
                    margin: isMobile ? 5 : 10 // smaller margins on mobile
                });
                
                // Add resize listener to regenerate barcode on screen size change
                window.addEventListener('resize', function() {
                    const currentScreenWidth = window.innerWidth;
                    const currentIsMobile = currentScreenWidth <= 768;
                    const currentIsTablet = currentScreenWidth <= 1024 && currentScreenWidth > 768;
                    
                    let newWidth = 2;
                    let newHeight = 100;
                    
                    if (currentIsMobile) {
                        newWidth = 1.5;
                        newHeight = 60;
                    } else if (currentIsTablet) {
                        newWidth = 1.8;
                        newHeight = 80;
                    }
                    
                    // Regenerate barcode with new dimensions
                    JsBarcode("#barcode", "{{ shipment.shipment_number }}", {
                        format: "CODE128",
                        width: newWidth,
                        height: newHeight,
                        displayValue: false,
                        background: "transparent",
                        lineColor: "#000000",
                        margin: currentIsMobile ? 5 : 10
                    });
                });
                
            } catch (e) {
                console.log("Barcode generation failed:", e);
            }
            {% endif %}
            
            // 6. Initialize Map if shipment exists
            {% if shipment %}
            let map = L.map('map').setView([51.505, -0.09], 13);
            
            // Map layers
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            });
            
            const satelliteLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: '© Google Maps'
            });
            
            // Add default layer
            osmLayer.addTo(map);
            
            // Map view controls
            document.getElementById('mapView')?.addEventListener('click', function() {
                map.removeLayer(satelliteLayer);
                osmLayer.addTo(map);
                this.classList.add('active');
                document.getElementById('satelliteView')?.classList.remove('active');
            });
            
            document.getElementById('satelliteView')?.addEventListener('click', function() {
                map.removeLayer(osmLayer);
                satelliteLayer.addTo(map);
                this.classList.add('active');
                document.getElementById('mapView')?.classList.remove('active');
            });
            
            // Add a marker
            L.marker([51.505, -0.09]).addTo(map)
                .bindPopup('Current Shipment Location<br><strong>{{ shipment.location.name|default:"In Transit" }}</strong>')
                .openPopup();
            {% endif %}
            
            // 7. Bootstrap tab functionality
            if (typeof jQuery !== 'undefined') {
                $('#trackingTabs a').on('click', function (e) {
                    e.preventDefault();
                    $(this).tab('show');
                });
                
                $('#trackingTabs a').on('shown.bs.tab', function (e) {
                    $('#trackingTabs a').removeClass('active');
                    $(e.target).addClass('active');
                });
            } else {
                // Fallback for tabs without jQuery
                const tabLinks = document.querySelectorAll('#trackingTabs a');
                tabLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const targetId = this.getAttribute('href');
                        const targetTab = document.querySelector(targetId);
                        
                        // Hide all tab panes
                        document.querySelectorAll('.tab-pane').forEach(pane => {
                            pane.classList.remove('show', 'active');
                        });
                        
                        // Show target tab
                        if (targetTab) {
                            targetTab.classList.add('show', 'active');
                        }
                        
                        // Update active tab
                        tabLinks.forEach(tab => tab.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
            }
        });
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                20%, 40%, 60%, 80% { transform: translateX(5px); }
            }
            
            @keyframes pulse {
                0% { transform: scale(1); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
                50% { transform: scale(1.02); box-shadow: 0 6px 20px rgba(229, 57, 53, 0.3); }
                100% { transform: scale(1); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
            }
            
            @keyframes shimmer {
                0% { background-position: -200% 0; }
                100% { background-position: 200% 0; }
            }
            
            .track-button {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            }
            
            .track-input {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            }
            
            .loading-spinner {
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            
            .fa-spin {
                animation: fa-spin 1s infinite linear !important;
            }
            
            @keyframes fa-spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            /* Glow effect on focus */
            #tracking_number:focus {
                outline: none;
                border: none;
                animation: input-glow 2s infinite alternate;
            }
            
            @keyframes input-glow {
                from {
                    box-shadow: 0 4px 25px rgba(0,0,0,0.25),
                                0 0 5px rgba(229, 57, 53, 0.2);
                }
                to {
                    boxShadow: 0 4px 25px rgba(0,0,0,0.25),
                               0 0 10px rgba(229, 57, 53, 0.4);
                }
            }
        `;
        document.head.appendChild(style);

        // And update the responsive adjustment function:
function adjustButtonText() {
    const width = window.innerWidth;
    const buttons = document.querySelectorAll('.track-button');
    
    buttons.forEach(button => {
        if (width <= 400) {
            button.innerHTML = '<i class="fa fa-search"></i>';
            button.style.minWidth = '60px';
        } else if (width <= 576) {
            button.innerHTML = '<i class="fa fa-search" style="margin-right: 4px;"></i> Track';
            button.style.minWidth = '90px';
        } else {
            button.innerHTML = '<i class="fa fa-search" style="margin-right: 6px;"></i> Track';
            button.style.minWidth = '140px';
        }
    });
}

// Call on load and resize
window.addEventListener('load', adjustButtonText);
window.addEventListener('resize', adjustButtonText);
    })();
</script>

<style>
    /* Additional styles for track page */
    .tracking-form-container form {
        position: relative;
        z-index: 1;
    }
    
    .tracking-form-container form:before {
        content: '';
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
        border-radius: 60px;
        z-index: -1;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .tracking-form-container form:hover:before {
        opacity: 1;
    }
    
    /* Tab styling */
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 20px;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #666;
        font-weight: 500;
        padding: 12px 25px;
        margin-right: 5px;
    }
    
    .nav-tabs .nav-link.active {
        background: #e53935;
        color: white;
        border-radius: 25px;
        border: none;
    }
    
    .nav-tabs .nav-link:hover {
        border: none;
        border-radius: 25px;
    }
    
    .tab-content {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        margin-top: 0px;
    }

    // make the input smaller
    /* Responsive Search Box with smaller button */
    .search-container {
        width: 100%;
        max-width: 700px;
        margin: 0 auto;
    }
    
    .track-input {
        flex: 1 !important;
        min-width: 0; /* Allows shrinking */
    }
    
    .track-button {
        min-width: 140px !important;
        max-width: 160px;
        flex-shrink: 0;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
        .search-container {
            max-width: 100% !important;
        }
        
        .track-input {
            padding: 14px 20px !important;
            font-size: 15px !important;
            min-height: 52px !important;
        }
        
        .track-button {
            padding: 14px 20px !important;
            font-size: 14px !important;
            min-height: 52px !important;
            min-width: 120px !important;
        }
        
        .track-button i {
            margin-right: 4px !important;
        }
    }
    
    @media (max-width: 576px) {
        .tracking-title {
            font-size: 24px !important;
            padding: 0 15px;
        }
        
        .tracking-subtitle {
            font-size: 15px !important;
            padding: 0 15px !important;
            margin-bottom: 25px !important;
        }
        
        .track-input {
            padding: 12px 18px !important;
            font-size: 14px !important;
            min-height: 48px !important;
            border-radius: 50px 0 0 50px !important;
        }
        
        .track-button {
            padding: 12px 15px !important;
            font-size: 14px !important;
            min-height: 48px !important;
            min-width: 100px !important;
            border-radius: 0 50px 50px 0 !important;
        }
        
        .track-button i {
            margin-right: 4px !important;
        }
    }
    
    @media (max-width: 400px) {
        .track-input {
            padding: 10px 15px !important;
            font-size: 13px !important;
            min-height: 44px !important;
        }
        
        .track-button {
            padding: 10px 12px !important;
            font-size: 13px !important;
            min-height: 44px !important;
            min-width: 90px !important;
        }
        
        .track-button i {
            margin-right: 3px !important;
            font-size: 14px;
        }
    }
    
    /* Tablet Optimization */
    @media (min-width: 769px) and (max-width: 1024px) {
        .search-container {
            max-width: 600px !important;
        }
        
        .track-input {
            padding: 16px 25px !important;
            min-height: 56px !important;
        }
        
        .track-button {
            padding: 16px 25px !important;
            min-height: 56px !important;
            min-width: 130px !important;
        }
    }
    
    /* Desktop Optimization */
    @media (min-width: 1200px) {
        .search-container {
            max-width: 750px !important;
        }
        
        .track-input {
            padding: 16px 30px !important;
            min-height: 58px !important;
        }
        
        .track-button {
            padding: 16px 35px !important;
            min-height: 58px !important;
            min-width: 150px !important;
        }
    }
    
    /* Ensure proper visual connection between input and button */
    .track-input:focus + .track-button {
        box-shadow: 0 4px 20px rgba(229, 57, 53, 0.2) !important;
    }
    
    /* Hover effects for better UX */
    .track-input:hover {
        box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;
    }
    
    .track-button:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
    }

    /* Responsive Barcode Styles */
    .barcode-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: inline-block;
        max-width: 100%;
        overflow: hidden;
        position: relative;
    }

    /* Mobile-specific barcode styles */
    @media (max-width: 768px) {
        .barcode-container {
            padding: 10px !important;
            margin: 0 auto;
            width: 95%;
        }
        
        #barcode {
            width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
        }
    }

    /* Tablet-specific barcode styles */
    @media (min-width: 769px) and (max-width: 1024px) {
        .barcode-container {
            padding: 15px !important;
            width: 90%;
        }
    }

    /* Hide horizontal scrollbar but keep functionality */
    .barcode-container::-webkit-scrollbar {
        height: 5px;
    }

    .barcode-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .barcode-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    .barcode-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Prevent page overflow */
    body {
        overflow-x: hidden;
        max-width: 100vw;
    }

    .container {
        max-width: 100%;
        overflow-x: hidden;
    }
</style>
{% endblock %}